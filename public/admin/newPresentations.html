<html>
<head>
  <title>New Presentation  - Impact Live Admin</title>
  <script src="/jquery/jquery.js" type="text/javascript"></script>
  <script src="/socket/socket.js" type="text/javascript"></script>
  <script src="admin.js" type="text/javascript"></script>
  <link href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" type="text/css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
  <script type="text/javascript" src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <link href="/admin/admin.css" type="text/css" rel="stylesheet">
  <style>
  tr{
  	border:1px solid black;
  	border-radius:5px;
  }
  .material-icons {
    margin-top:0;

  }
.md-dark{
  	float:none;
  	display: block;
  	width:200px;
    vertical-align: middle;
    text-align: center;
    margin-left:10px;
    font-size:200px;
    color: rgba(230, 230, 230, 1);
    top: calc(50% - 2rem);
    z-index: 0;
    height:200px;
    overflow:hidden;
  }
  .deleteImage{
    font-size:36px;
    color:#666;
    position:relative;
    margin-left:220px;
    margin-top:-20px;
    top:0;
    height:36px;
    width:36px;
  }

  </style>
  <script>
  $(document).ready(function() {
    var thisid;
  $("body").on("click",".deleteImage",function(e){
    e.preventDefault();
    deleteImage(this);
  });
  function deleteImage(that){
    var data='{"filename":"' + $(that).data('filename')+ '"}';
    $.ajax({
       url: '/delete-s3',
       contentType: 'application/json',
       data: data,
       type: 'POST',
       dataType: "json",
       success: function(data){
         if(data.data=="ok"){
           $(that).siblings('.uploaded').hide('fast');
           $(that).siblings('.previewimg').show('fast');
           $(that).remove();
         }
         else{
           console.log(data.data);
         }
       },
       failure: function(errMsg) {
           console.log('error');
       }

   });
 }
  $('.file-input').change(function() {
    thisid=$(this).parent();
    //var this=this;
    if(this.files && this.files[0]){
      alert('files');
      /* this is going to load up the thumbnails in a temporary browser spot*/

      const files = this.files;
      const file = files[0];

      if(file == null){
        return alert('No file selected.');
      }
      var fileExtension = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
      fileType=file.type.toLowerCase();
      alert(fileType);
      if (fileExtension.indexOf(fileType) == -1) {
           alert("Only files of type jpg, png, gif, jpeg are allowed");
           return false;
      }
      else{
        /* image dimensions*/

        img=new Image();
        var _URL = window.URL || window.webkitURL;
        img.src = _URL.createObjectURL(file);
        img.onload=function(){
          alert('oad');
          fileSize=(file.size/1024/1024).toFixed(2);
          if(this.width<350 || this.height<200){
            alert('The minimum width for an image is 350 px. The minimum height is 200 px');
            return false;
          }
          else if (fileSize >4){
            alert('Max file size is 4MB');
            return false;
         }
         else{
           var reader = new FileReader();
           reader.onload=function(e){
             $(thisid).find('.hiddenSrc').val('');
             $(thisid).find('.previewimg').hide('fast');
             $(thisid).find(".uploaded").remove();
             $(thisid).find(".deleteImage").remove();
             $(thisid).find(".deleteThumb").remove();
             $(thisid).prepend("<i class='material-icons md-184 md-inactive md-dark deleteImage deleteThumb'>delete</i><div style='width:184px;height:150px;padding:0;text-align:0;' class='uploaded'><img src='"+e.target.result+"' class='thumb' style='max-width:180px'></div>").fadeIn('slow').css("display","block");
           }
           reader.readAsDataURL(this.files[0]);
        }

      }
    }
  }

});
  var userID=getCookie('impactLive');

  function uploadFile(file, signedRequest, fileName){

    const xhr = new XMLHttpRequest();
    xhr.open('PUT', signedRequest);
    xhr.onreadystatechange = () => {
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          url="https://d325v2sfwqo3gd.cloudfront.net/fit-in/210x210/images/" + fileName;
          urlFull="https://d325v2sfwqo3gd.cloudfront.net/fit-in/350x350/images/" + fileName;
          //$(thisid).find(".deleteImage").trigger("click");
          console.log(thisid);
          $(thisid).find('.hiddenSrc').val(urlFull);
          $(thisid).find('.previewimg').hide('fast');
          var curImgSrc=$(thisid).find(".thumb").attr('src');
          $(thisid).find(".uploaded").remove();
          $(thisid).find(".deleteImage").remove();
          $(thisid).prepend("<i class='material-icons md-184 md-inactive md-dark deleteImage' data-filename='"+fileName+"'>delete</i><div style='width:184px;height:150px;padding:0;text-align:0;max-width:180px' class='uploaded'><a href='"+urlFull+"' target='_blank'><img src='"+url+"' class='thumb' style='max-width:180px'></a></div>").fadeIn('slow').css("display","block");

        }
        else{
          alert('Could not upload file.');
        }
      }
    };
    xhr.send(file);
  }
  /*
    Function to get the temporary signed request from the app.
    If request successful, continue to upload the file using this signed
    request.
  */
  function getFileExtension(filename) {
    return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2);
  }
  function getSignedRequest(file){
    const xhr = new XMLHttpRequest();
    var fileNameOnly=file.name;
    fileNameOnly=fileNameOnly.replace(/\.[^/.]+$/, "");
    fileExt=getFileExtension(file.name);
    newFileName=fileNameOnly + '_' + userID + '_99999' + '.' + fileExt;
    const myNewFile = new File([file], newFileName, {type: file.type});
    xhr.open('GET', `/sign-s3?file-name=${myNewFile.name}&file-type=${myNewFile.type}&userid=${userID}`);
    xhr.onreadystatechange = () => {
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          const response = JSON.parse(xhr.responseText);
          uploadFile(myNewFile, response.signedRequest, myNewFile.name);
        }
        else{
          alert('Could not get signed URL.');
        }
      }
    };
    xhr.send();
  }
  /*
   Function called when file input updated.
  */
  function initUpload(fileInput){

    const files = $(fileInput).prop('files');
    const file = files[0];

    if(file == null){
      return alert('No file selected.');
    }
    var fileExtension = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    fileType=file.type.toLowerCase();
    if (fileExtension.indexOf(fileType) == -1) {
         alert("Only files of type jpg, png, gif, jpeg are allowed");
         return false;
    }
    else{
      /* image dimensions*/
      img=new Image();
      var _URL = window.URL || window.webkitURL;
      img.onload=function(){
        fileSize=(file.size/1024/1024).toFixed(2);
        if(this.width<350 || this.height<200){
          alert('The minimum width for an image is 350 px. The minimum height is 200 px');
          return false;
          //getSignedRequest(file,this.src);
        }
        else if (fileSize >4){
          alert('Max file size is 4MB');
          return false;
       }
       else{
         getSignedRequest(file,this.src);
       }

      }
      img.src = _URL.createObjectURL(file);
    }
  }
  if(!userID){
    window.location="/admin/index.html";
  }
  else{
      $("#userid").val(userID);
      $('form').submit(function (e) {
        e.preventDefault();
        //console.log(toJSONString(this));
      //  initUpload($("#companylogourl"));
       $.ajax({
          url: '/newrecord/',
          contentType: 'application/json',
          data:  toJSONString( this ),
          type: 'POST',
          dataType: "json",
          success: function(data){

            if(data.data=="ok"){
              window.location="/admin/presentations.html";
            }
            else{
              //console.log(data);
            }
          },
          failure: function(errMsg) {
              console.log('error');
          }

      });
      return false;
     });
   }
  });
</script>


</head>
<body>
<div class="topbar">
  <div class="topbar-colors">
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
  </div>
  <nav>
  Impact Live - New Presentation
  </nav>
</div>
<br><br>
<form method="post" enctype="multipart/form-data">
  <table id="presentationForm" width="45%" align="center" cellspacing="5" cellpadding="10" style="border-collapse: collapse;background:#fff;">
    <tr>
      <td>Company Name * </td>
      <td><input type="text" name="companyname" id="companyname" required></td>
   </tr>
   <tr>
     <td>Company Logo * <br><span style="font-size:smaller"></td>
     <td><div id="previewlogo" align="center" class="preview"><i class="material-icons md-184 md-inactive md-dark previewimg">
photo_size_select_actual
</i><br><input type="file" class="file-input blue" id="companylogourl"  required><input type="hidden" class="hiddenSrc" name="companylogourl"></div></td>
  </tr>
  <tr>
    <td>Push Content 1 *<br><div class="explain">Must be jpg, png, or jpeg,350px wide minimum, and be a picture of an email</div></td>
    <td><div id="preview1" align="center" class="preview" ><i class="material-icons md-184 md-inactive md-dark previewimg">
photo_size_select_actual
</i><br><input type="file" class="file-input blue" id="image1" required><input type="hidden" class="hiddenSrc" name="pushcontent1url"></div>
    </td>
  </tr>
  <tr>
    <td>Email Subject *<br>
      <div class="explain">Subject line for the first email (uploaded above)</div></td>
    <td><input type="text" name="email1subject" id="email1subject" required></td>
  </tr>
  <tr>
    <td>Push Content 2<br>
    <div class="explain">Must be jpg, png, or jpeg and 350px wide minimum</div></td>
    <td><div id="preview2" class="preview" align="center"><i class="material-icons md-184 md-inactive md-dark previewimg">
photo_size_select_actual
</i><br><input type="file" class="file-input blue" id="image2"><input type="hidden" class="hiddenSrc" name="pushcontent2url"></div></td>
  </tr>
  <tr>
    <td>Push Content 3<br>
    <div class="explain">Must be jpg, png, or jpeg and 350px wide minimum</div></td>
    <td><div id="preview3" align="center" class="preview"><i class="material-icons md-184 md-inactive md-dark previewimg">
photo_size_select_actual
</i><br><input type="file" class="file-input blue" id="image3"><input type="hidden" class="hiddenSrc" name="pushcontent3url"></div></td>
  </tr>
  <tr>
    <td>Push Content 4<br>
    <div class="explain">Must be jpg, png, or jpeg and 350px wide minimum</div></td>
    <td><div id="preview4" align="center" class="preview" ><i class="material-icons md-184 md-inactive md-dark previewimg">
photo_size_select_actual
</i><br><input type="file" class="file-input blue"  id="image4"><input type="hidden" class="hiddenSrc" name="pushcontent4url"></div></td>
  </tr>
  <tr>
    <td>Push Content 5<br>
    <div class="explain">Must be jpg, png, or jpeg and 350px wide minimum</div></td>
    <td><div id="preview5" align="center" class="preview" ><i class="material-icons md-184 md-inactive md-dark previewimg">
photo_size_select_actual
</i><br><input type="file" class="file-input blue"  id="image5"><input type="hidden" class="hiddenSrc" name="pushcontent5url"></div></td>
  </tr>

  <tr>
    <td>Survey URL<br>
      <div class="explain">If provided, survey link will display on end page</div></td>
    <td><input type="text" name="surveylink" id="surveylink"></td>
  </tr>
  <tr>
      <td style="border:none"><input type="hidden" name="userid" id="userid"><input type="hidden" name="presentationid" id="presentationid"></td>
      <td style="border:none"><br><input type="submit" id="editPresentation" class="green" style="float:left;width:200px;height:50px;cursor:pointer;border:2px solid #000;margin-left:40px;font-size:16px" value="Save"></td>
    </tr>
  </table>
</form>
</body>
</html>
