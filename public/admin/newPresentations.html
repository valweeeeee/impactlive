<html>
<head>
  <title>New Presentation  - Impact Live Admin</title>
  <script src="/jquery/jquery.js" type="text/javascript"></script>
  <script src="/socket/socket.js" type="text/javascript"></script>
  <script src="admin.js" type="text/javascript"></script>
  <link href="//cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" type="text/css" rel="stylesheet">
  <script type="text/javascript" src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
  <link href="/admin/admin.css" type="text/css" rel="stylesheet">
  <style>
  td{
  	border:1px solid black;
  	border-radius:5px;
  }
  </style>
  <script>
  $(document).ready(function() {
    var thisid;
  $("window").on("click",".deleteImage",function(){
    alert('here');
    console.log($(this).data('filename'));
    /*$.ajax({
       url: '/delete-s3',
       contentType: 'application/json',
       data:  toJSONString( this ),
       type: 'POST',
       dataType: "json",
       success: function(data){

         if(data.data=="ok"){

         }
         else{

         }
       },
       failure: function(errMsg) {
           console.log('error');
       }

   });*/

  });
  $('.file-input').change(function() {
      thisid=$(this).prev('div');
      return initUpload(this);
  });
  var userID=getCookie('impactLive');

  function uploadFile(file, signedRequest, fileName){
    const xhr = new XMLHttpRequest();
    xhr.open('PUT', signedRequest);
    xhr.onreadystatechange = () => {
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          //document.getElementById('preview1').src = url;
          url="https://d325v2sfwqo3gd.cloudfront.net/fit-in/150x150/images/" + fileName;
          urlFull="https://d325v2sfwqo3gd.cloudfront.net/fit-in/350x350/images/" + fileName;
          $(thisid).html("<a href='"+urlFull+"' target='_blank'><img src='"+url+"' ></a><a href='#' class='deleteImage' data-filename='"+fileName+"' style='font-size:larger;float:right;margin-right:180px;margin-top:0px;color:red;'>X</a><br>");
          $(thisid).fadeIn('slow').css("display","block");

        }
        else{
          alert('Could not upload file.');
        }
      }
    };
    xhr.send(file);
  }
  /*
    Function to get the temporary signed request from the app.
    If request successful, continue to upload the file using this signed
    request.
  */
  function getFileExtension(filename) {
    return filename.slice((filename.lastIndexOf(".") - 1 >>> 0) + 2);
  }
  function getSignedRequest(file){
    const xhr = new XMLHttpRequest();
    var fileNameOnly=file.name;
    fileNameOnly=fileNameOnly.replace(/\.[^/.]+$/, "");
    fileExt=getFileExtension(file.name);
    newFileName=fileNameOnly + '_' + userID + '_99999' + '.' + fileExt;
    const myNewFile = new File([file], newFileName, {type: file.type});
    xhr.open('GET', `/sign-s3?file-name=${myNewFile.name}&file-type=${myNewFile.type}&userid=${userID}`);
    xhr.onreadystatechange = () => {
      if(xhr.readyState === 4){
        if(xhr.status === 200){
          const response = JSON.parse(xhr.responseText);
          uploadFile(myNewFile, response.signedRequest, myNewFile.name);
        }
        else{
          alert('Could not get signed URL.');
        }
      }
    };
    xhr.send();
  }
  /*
   Function called when file input updated.
  */
  function initUpload(fileInput){

    const files = $(fileInput).prop('files');
    const file = files[0];

    if(file == null){
      return alert('No file selected.');
    }
    var fileExtension = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    fileType=file.type.toLowerCase();
    if (fileExtension.indexOf(fileType) == -1) {
         alert("Only files of type jpg, png, gif, jpeg are allowed");
         return false;
    }
    else{
      /* image dimensions*/
      img=new Image();
      var _URL = window.URL || window.webkitURL;
      img.onload=function(){
        fileSize=(file.size/1024/1024).toFixed(2);
        if(this.width<350){
          alert('The minimum width for an image is 350');
          return false;
          //getSignedRequest(file,this.src);
        }
        else if (fileSize >4){
          alert('Max file size is 4MB');
          return false;
       }
       else{
         getSignedRequest(file,this.src);
       }

      }
      img.src = _URL.createObjectURL(file);
    }
  }
  if(!userID){
    window.location="/admin/index.html";
  }
  else{
      $("#userid").val(userID);
      $('form').submit(function (e) {
        e.preventDefault();
       $.ajax({
          url: '/newrecord/',
          contentType: 'application/json',
          data:  toJSONString( this ),
          type: 'POST',
          dataType: "json",
          success: function(data){

            if(data.data=="ok"){
              window.location="/admin/presentations.html";
            }
            else{
              console.log(data);
            }
          },
          failure: function(errMsg) {
              console.log('error');
          }

      });
      return false;
     });
   }
  });
</script>


</head>
<body>
<div class="topbar">
  <div class="topbar-colors">
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
      <i class="green"></i>
  </div>
  <nav>
  Impact Live - New Presentation
  </nav>
</div>
<br><br>
<form method="post" enctype="multipart/form-data">
  <table id="presentationForm" width="45%" align="center" cellspacing="5" cellpadding="10">
    <tr>
      <td>Company Name * </td>
      <td><input type="text" name="companyname" id="companyname" required></td>
   </tr>
   <tr>
     <td>Company Logo<br><span style="font-size:smaller"></td>
     <td valign=><div id="previewlogo" align="center" class="preview"></div><input type="file" class="file-input blue" name="companylogourl" id="companylogourl" id="logoimage"></td>
  </tr>
  <tr>
    <td>Push Content 1 <span class="tooltip" style="font-weight:bold">&nbsp;?<span class="tooltiptext">Must be jpg, gif, png, or jpeg - 350px wide minimum and be a picture of an email</span></span></td>
    <td><div id="preview1" align="center" class="preview" ></div><input type="file" class="file-input blue" name="pushcontent1url" id="image1">
    </td>
  </tr>
  <tr>
    <td>Push Content 2<span class="tooltip" style="font-weight:bold">&nbsp;?<span class="tooltiptext">Must be jpg, gif, png, or jpeg - 350px wide minimum</span></span></td>
    <td><div id="preview2" class="preview" align="center"></div><input type="file" class="file-input blue" name="pushcontent2url" id="image2"></td>
  </tr>
  <tr>
    <td>Push Content 3<span class="tooltip" style="font-weight:bold">&nbsp;?<span class="tooltiptext">Must be jpg, gif, png, or jpeg - 350px wide minimum</span></span></td>
    <td><div id="preview3" align="center" class="preview"></div><input type="file" class="file-input blue" name="pushcontent3url" id="image3"></td>
  </tr>
  <tr>
    <td>Push Content 4<span class="tooltip" style="font-weight:bold">&nbsp;?<span class="tooltiptext">Must be jpg, gif, png, or jpeg - 350px wide minimum</span></span></td>
    <td><div id="preview4" align="center" class="preview" ></div><input type="file" class="file-input blue" name="pushcontent4url" id="image4"></td>
  </tr>
  <tr>
    <td>Push Content 5<span class="tooltip" style="font-weight:bold">&nbsp;?<span class="tooltiptext">Must be jpg, gif, png, or jpeg - 350px wide minimum</span></span></td>
    <td><div id="preview5" align="center" class="preview" ></div><input type="file" class="file-input blue" name="pushcontent5url" id="image5"></td>
  </tr>
  <tr>
    <td>Email Subject<span class="tooltip" style="font-weight:bold">&nbsp;?<span class="tooltiptext">Subject line for the first email</span></span></td>
    <td><input type="text" name="email1subject" id="email1subject"></td>
  </tr>
  <tr>
    <td>Survey URL<span class="tooltip" style="font-weight:bold">&nbsp;?<span class="tooltiptext">If provided, survey link will display on end page</span></span></td>
    <td><input type="text" name="surveylink" id="surveylink"></td>
  </tr>
  <tr>
      <td style="border:none"><input type="hidden" name="userid" id="userid"><input type="hidden" name="presentationid" id="presentationid"></td>
      <td style="border:none"><br><input type="submit" id="editPresentation" class="green" style="float:left;width:200px;height:50px;cursor:pointer;border:2px solid #000;margin-left:40px;font-size:16px" value="Save"></td>
    </tr>
  </table>
</form>
</body>
</html>
